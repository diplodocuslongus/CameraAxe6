<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<!-- Suppress browser request for favicon.ico -->
		<link rel="icon" href="data:;base64,iVBORw0KGgo=">
		<title>Camera Axe 6</title>

		<style>
			body{
				font-family: "arial";
				font-size: 32px;
				background-color: #F5F5F5;
				color: #424242;
			}
			button {
				margin: 5px;
				padding: 20px;
				color: #ffffff;
				font-size: 48px;
				line-height: 1em;
				border: 0px;
				border-radius: 20px;
				background: #0D47A1;
			}
			button:hover {
				background: #1976D2;
			}
			.button1 {
				width: 80%;
				text-align: left;
			}
			.input1{
				background-color: #BBDEFB;
				color: #424242;
				border-radius: 15px;
				border: 2px solid #0D47A1;
				padding: 20px;
				margin: 5px;
				font-size: 48px;
				width: 190px;
			}
			.inputSlider{
				background-color: #BBDEFB;
				color: #424242;
				border-radius: 15px;
				border: 2px solid #0D47A1;
				padding: 20px;
				margin: 5px;
				font-size: 48px;
				width: 120px;
			}
			.inputTimebox{
				background-color: #BBDEFB;
				color: #424242;
				border-radius: 15px;
				border: 2px solid #0D47A1;
				padding: 20px;
				margin: 5px;
				font-size: 48px;
				width: 440px;
			}
			.select1{
				background-color: #BBDEFB;
				color: #424242;
				border-radius: 15px;
				border: 2px solid #0D47A1;
				padding: 20px;
				margin: 5px;
				font-size: 48px;
			}
			.select1 option {
				background: #BDBDBD;
			}
			.colorbox{
				border-radius: 20px;
				background-color: #BDBDBD;
			}
			h1{
				margin: 12px;
				color: #0D47A1;
				font-size: 48px;
				font-weight: 800;
			}
			.text1{
				margin: 12px;
				font-size: 40px;
				color: #ffffff;
			}
			label.checkbox input[type="checkbox"] {display:none; -webkit-appearance: none;}
			label.checkbox span {
				display:inline-block;
				border:2px solid #0D47A1;
				border-radius:15px;
				width:50px;
				height:50px;
				background:#BBDEFB;
				vertical-align:middle;
				margin:2px;
				position: relative;
			}
			label.checkbox :checked + span {
				background-color: #0D47A1;
			}
			label.checkbox :checked + span:after {
				content: "\2714\fe0e"; /*2714 is check mark and fe0e is don't render as emoji*/
				font-size: 40px;
				top: -4px;
				left: 10px;
				position: absolute;
				color: #FFFFFF;
			}
			.mainBox {
				min-width: 600px;
				max-width: 1000px;
				padding: 16px;
				display: none;
			}
			.modal {
				display: none;
				position: fixed;
				z-index: 1; /* Sit on top */
				padding-top: 20px;
				left: 0;
				top: 0;
				width: 100%; /* Full width */
				height: 100%; /* Full height */
				overflow: auto; /* Enable scroll if needed */
			}
			.modal-content {
				background-color: #fefefe;
				margin: auto;
				padding: 20px;
				border: 1px solid #888;
				width: 800px;
			}
			.close {
				color: #aaaaaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
			}
			.close:hover,
			.close:focus {
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}
			.fullWidth{
				width: 100%;
			}
			#listButtons{
				padding: 12px;
				text-align: left;
			}
			.modeTable {
				border-collapse: collapse;
			}
			.modeCell {
				text-align: left;
				padding: 8px;
			}
			.slider {
				-webkit-appearance: none;
				width: 310px;
				height: 24px;
				margin: 5px;
				border-radius: 5px;
				background: #BBDEFB;
				outline: none;
			}
			.slider:hover {
				background: #90CAF9
			}
			.slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background: #0D47A1;
				cursor: pointer;
			}
			.slider::-moz-range-thumb {
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background: #0D47A1;
				cursor: pointer;
			}
			ul {
				list-style: none;
				padding:0px;
				margin:0px;
			}
			li {
				display: inline-block;
			}
		</style>

		<script>
			/*Javascript linting done with http://jshint.com/ */
			/*jshint esversion: 6 */
			const PID_STRING = 1;
			const PID_UINT32 = 2;
			const PID_TIME_BOX = 3;
			const PID_MENU_SELECT = 4;
			const PID_CAM_SETTINGS = 5;
			const PID_INTERVALOMETER = 6;
			const PID_CAM_TRIGGER = 7;

			// Global Variables
			var uiTestMode = false;
			var gXmlHttpRequests = new Array();
			var gInfoString;
			var gMode = 0;              // Tracks whether in menuMode (0) or photoMode (1)
			var gMenuModeTable = null;  // MenuMode table element for dynamic menus
			var gPhotoModeTable = null; // PhotoMode table element for dynamic menus
			var gCurTable = null;       // Currently active table (either gMenuModeTable or gPhotoModeTable)
			var gDynamicMenuName;       // The current dynamic menu name
			var gCamSelectVal = 0;      // The current camera/flash selected in the UI
			var gHttpRequest = "";      // String that accumulates data to send via httpRequest
			var gCamSettingsArray = [
				"5~0~1~0~0~0~0~0~0~0~0~", "5~1~1~0~0~0~0~0~0~0~0~",
				"5~2~1~0~0~0~0~0~0~0~0~", "5~3~1~0~0~0~0~0~0~0~0~",
				"5~4~1~0~0~0~0~0~0~0~0~", "5~5~1~0~0~0~0~0~0~0~0~",
				"5~6~1~0~0~0~0~0~0~0~0~", "5~7~1~0~0~0~0~0~0~0~0~"
			];

			// Load in the default values and initialize the UI
			window.onload = initPage;

			function initPage() {
				var i;
				for (i=0; i<4; i++) {
					gXmlHttpRequests[i] = new XMLHttpRequest();
					gXmlHttpRequests[i].inUse = false;
				}
				
				buildHttpRequest("JSCA_GET_MENU_LIST", false);
				buildHttpRequest("JSCA_GET_INTERVAL", false);
				buildHttpRequest("JSCA_GET_ALL_CAMS", false);
				buildHttpRequest("JSCA_GET_START_LOCATION", false);
				loadPage("Home", null, null);

				if (uiTestMode) {
					LoadMenuList(["Dummy Menu 1", "Dummy Menu 2"]);
				}
				getMenuDynamicIds();

				// When the user clicks on <span> (x), close the time box modal
				var span = document.getElementsByClassName("close")[0];
				span.onclick = function() {
					var modal = document.getElementById("timeboxModal");
					modal.style.display = "none";
				};

				// When the user clicks anywhere outside of the time box modal, close it
				window.onclick = function(event) {
					var modal = document.getElementById("timeboxModal");

					if (event.target === modal) {
						modal.style.display = "none";
					}
				};
				camSelectButton(0);
			}

			// Called to make one of the top level pages visible
			function loadPage(page, dynamicScript, submitPacketFunc) {
				document.getElementById("Home").style.display = "none";
				document.getElementById("MenuMode").style.display = "none";
				document.getElementById("CameraFlash").style.display = "none";
				document.getElementById("Intervalometer").style.display = "none";
				document.getElementById("Advanced").style.display = "none";
				if (page !== "MenuMode" || uiTestMode) {  // MenuMode is a special case which we make visible after scripts are loaded
					document.getElementById(page).style.display = "block";
				}
				if (dynamicScript !== null) {
					// Load the dynamic menu script
					buildHttpRequest("JSCA_GET_CURRENT_DYNAMIC_MENU", true, dynamicScript);
					gDynamicMenuName = dynamicScript;
				}
				toggleMenuPhotoMode(true, dynamicScript, submitPacketFunc);
			}

			// Change between menu mode and photo mode on dynamic menus
			function toggleMenuPhotoMode(forceMenuMode, dynamicScript, submitPacketFunc) {
				var menuModeButtonId = document.getElementById("MenuPhotoModeButton");
				var testButtonId = document.getElementById("MenuModeTestTriggerButton");
				var infoButtonId = document.getElementById("MenuInfoButton");
				var triggerCamsId = document.getElementById("MenuModeTriggerCamsButton");

				if (forceMenuMode) {
					menuModeButtonId.innerHTML = "Photo Mode";
					testButtonId.style.display = "initial";
					infoButtonId.style.display = "initial";
					triggerCamsId.style.display = "none";
					if (gMenuModeTable && gPhotoModeTable) {
						gMenuModeTable.style.display = "table";
						gPhotoModeTable.style.display = "none";
					}
					gMode = 0;
				}
				else {  // Toggle mode
					if (menuModeButtonId.innerHTML === "Photo Mode") {
						menuModeButtonId.innerHTML = "Menu Mode";
						testButtonId.style.display = "none";
						infoButtonId.style.display = "none";
						triggerCamsId.style.display = "initial";
						gMenuModeTable.style.display = "none";
						gPhotoModeTable.style.display = "table";
						gMode = 1;
					}
					else {
						menuModeButtonId.innerHTML = "Photo Mode";
						testButtonId.style.display = "initial";
						infoButtonId.style.display = "initial";
						triggerCamsId.style.display = "none";
						gMenuModeTable.style.display = "table";
						gPhotoModeTable.style.display = "none";
						gMode = 0;
					}
				}
				if (submitPacketFunc !== null) {
					submitPacketFunc();
				}
				var val = PID_MENU_SELECT+"~"+gMode+"~"+dynamicScript+"~";
				buildHttpRequest("JSCA_RAW_PACKET", true, val);

			}

			function buildHttpRequest(header, submit, data) {
				gHttpRequest += header + "&~&";
				if (data !== null && data !== undefined) {
					gHttpRequest += data + "&~&";
				}
				if (submit) {
					var type = "GET";
					var request = null;
					var i;
					for(i=0; i<gXmlHttpRequests.length; i++) {
						if (gXmlHttpRequests[i].inUse == false) {
							request = gXmlHttpRequests[i];
							break;
						}
					}
					
					if (request == null) {
						document.getElementById("debugText").innerHTML = "Failed to find free XmlHttpRequest.  Try reloading page.";
					}
					request.inUse = true;
					request.onreadystatechange = function(){ajaxCallback(request);};
					request.open(type, gHttpRequest, true);
					request.send();
					request.timeout = 2000;
					request.ontimeout = function() {
							document.getElementById("debugText").innerHTML = "Network timeout.  Try reloading page.";
							request.inUse = false;
							};
					gHttpRequest = "";
					return request;
				}
			}

			// Checks ever n ms for a packet update from the esp8266 server
			function getMenuDynamicIds() {
				setTimeout(getMenuDynamicIds, 500);

				if (document.getElementById("MenuMode") !== null &&
					document.getElementById("MenuMode").style.display !== "none") {
					// Only send the request if the dynamic menu is visible
					buildHttpRequest("JSCA_GET_MENU_DYNAMIC_STRING_IDS", false);
					buildHttpRequest("JSCA_GET_MENU_DYNAMIC_UINT32_IDS", true);
				}
			}

			// Loads the names of all the different dynamic menus
			function LoadMenuList(photoMenus) {
				var listItems = "";
				photoMenus.forEach(function(item) {
					listItems += "<button class=\"fullWidth\" onclick=\"loadPage('MenuMode', '"+item+"', null);\">"+item+"</button>";
				});
				document.getElementById("listButtons").innerHTML = listItems;

				// Clear out the start location dropdown box and then fill it
				var startLocationSelect = document.getElementById("start_location");
				while(startLocationSelect.firstChild) {
					startLocationSelect.removeChild(startLocationSelect.firstChild);
				}

				var z = document.createElement("option");
				z.textContent = "Home Page (default)";
				z.value = "Home Page (default)";
				startLocationSelect.appendChild(z);

				photoMenus.forEach(function(item) {
					z = document.createElement("option");
					z.textContent = item;
					z.value = item;
					startLocationSelect.appendChild(z);
				});
			}

			// General function used to validate a number is in required range
			function validateNumber(x, sliderId) {
				var maxLength = x.max.toString().length;
				if (x.value.length > maxLength) {
					x.value = x.value.slice(0,maxLength);
				}
				if (x.value.length > 1 && x.value[0] === "0"){
					x.value = (x.value).replace("0","");
				}
				if (x.value < 0 || x.value === "") {
					x.value = 0;
				}
				if (+x.value > +x.max) {
					x1.value = x.max;
				}
				if (sliderId !== null && document.getElementById(sliderId) !== null) {
					document.getElementById(sliderId).value = x.value;
				}
			};

			function ajaxCallback(xmlHttpRequest) {
				if ((xmlHttpRequest.readyState === 4) && (xmlHttpRequest.status === 200)) {
					var ajaxList = xmlHttpRequest.responseText.slice(0, -3).split("&~&");
					var stateList, strArray, name;
					for (var i=0; i<ajaxList.length; i+=2) {
						switch(ajaxList[i]) {
							case "JSCA_GET_MENU_LIST": {
								var menuList = ajaxList[i+1].slice(0, -1).split("~");
								LoadMenuList(menuList);
								break;
							}
							case "JSCA_GET_MENU_DYNAMIC_STRING_IDS": {
								if (ajaxList[i+1] !== "null") {
									stateList = ajaxList[i+1].slice(0, -1).split("~");
									for (i=0; i<stateList.length; i+=2) {
										document.getElementById(stateList[i]).innerHTML = stateList[i+1];
									}
								}
								break;
							}
							case "JSCA_GET_MENU_DYNAMIC_UINT32_IDS": {
								if (ajaxList[i+1] !== "null") {
									stateList = ajaxList[i+1].slice(0, -1).split("~");
									for (i=0; i<stateList.length; i+=2) {
										document.getElementById(stateList[i]).value = stateList[i+1];
									}
								}
								break;
							}
							case "JSCA_GET_CURRENT_DYNAMIC_MENU": {
								eval(ajaxList[i+1]);
								buildHttpRequest("JSCA_GET_DYNAMIC_MENU_SETTINGS", true, gDynamicMenuName);
								break;
							}
							case "JSCA_GET_INTERVAL": {
								if (ajaxList[i+1] !== "null") {
									strArray = ajaxList[i+1].split("~");
									strArray.pop(); // Last element is empty
									var intervalForm = document.getElementById("intervalometerForm");
									intervalForm.elements.inter_enable.checked = (strArray[1] === "0")? false : true;
									intervalForm.elements.start_delay.value = getTimeBoxString(strArray[2], strArray[3]);
									intervalForm.elements.interval.value = getTimeBoxString(strArray[4], strArray[5]);
									intervalForm.elements.number_of_repeats.value = strArray[6];
								}
								break;
							}
							case "JSCA_GET_ALL_CAMS": {
								if (ajaxList[i+1] !== "null") {
									strArray = ajaxList[i+1].split("&");
									strArray.pop(); // Remove last empty element since there is a terminating "&"
									gCamSettingsArray = strArray;
									camSettingsLoad(0);
								}
								break;
							}
							case "JSCA_GET_DYNAMIC_MENU_SETTINGS": {
								if (ajaxList[i+1] === "null") {
									document.getElementById("MenuMode").style.display = "block";  // Make this visible now
								}
								else {
									strArray = ajaxList[i+1].split("&");
									strArray.pop(); // Remove last empty element since there is a terminating "&"
									loadMenuModeFromPacket(strArray);
									document.getElementById("MenuMode").style.display = "block";  // Make this visible now
								}
								break;
							}
							case "JSCA_GET_START_LOCATION": {
								name = ajaxList[i+1];
								var startLocationSelect = document.getElementById("start_location");
								startLocationSelect.value = name;
								break;
							}
							case "JSCA_GET_VOLTAGE": {
								name = ajaxList[i+1];
								var voltage = document.getElementById("current_voltage");
								voltage.innerHTML = name;
								break;
							}
							case "JSCA_SET_DEFAULTS":
							case "JSCA_RAW_PACKET":
							case "JSCA_CLEAR_WIFI_NETWORKS":
							case "JSCA_SET_ALL_CAMS":
							case "JSCA_SET_START_LOCATION":
							case "JSCA_SET_DYNAMIC_MENU":
							{
								name = ajaxList[i+1];
								if (name !== "done") {
									alert("Invalid ajax return");
								}
								break;
							}
							default:
								alert("Invalid ajaxCallback id");
						}
					}
					xmlHttpRequest.inUse = false;
				}
			}

			// Get the nanoseconds from a time box string
			// This could be updated to support nanoseconds just by putting them in array slot [6]
			function getNanoseconds(time) {
				var timeArray = time.split(new RegExp("[.:]", "g")); // index 0 is days and index 5 is microseconds
				var x = +timeArray[5]*1000 + timeArray[4]*1000000;
				return x;
			}

			// Get the seconds from a time box string
			function getSeconds(time) {
				var timeArray = time.split(new RegExp("[.:]", "g")); // index 0 is days and index 5 is microseconds
				var x = +timeArray[3] + timeArray[2]*60 + timeArray[1]*60*60 + timeArray[0]*60*60*24;
				return x;
			}

			// Convert seconds and nanoseconds into a time box string
			function getTimeBoxString(inSec, inNano) {
				var days = Math.floor(inSec/(60*60*24));
				var hours = Math.floor(inSec/(60*60) - days*24);
				var minutes = Math.floor(inSec/60 - days*60*24 - hours*60);
				var seconds = inSec - days*60*60*24 - hours*60*60 - minutes*60;
				var ms = Math.floor(inNano/(1000*1000));
				var us = Math.floor(inNano/1000 - ms*1000);
				//var ns = inNano - ms*1000*1000 - us*1000;
				var str = days + "." + hours + ":" + minutes + ":" + seconds + "." + ms + "." + us;
				return str;
			}

			// When the user clicks the input, open the timebox modal
			function openTimeBox(box, days, hours, minutes, seconds, milliseconds, microseconds) {
				if(days){
					document.getElementById("days").style.display = "";
					document.getElementsByName("days")[0].value=0;
				}else{
					document.getElementById("days").style.display = "none";
				}

				if(hours){
					document.getElementById("hours").style.display = "";
					document.getElementsByName("hours")[0].value=0;
				}else{
					document.getElementById("hours").style.display = "none";
				}

				if(minutes){
					document.getElementById("minutes").style.display = "";
					document.getElementsByName("minutes")[0].value=0;
				}else{
					document.getElementById("minutes").style.display = "none";
				}

				if(seconds){
					document.getElementById("seconds").style.display = "";
					document.getElementsByName("seconds")[0].value=0;
				}else{
					document.getElementById("seconds").style.display = "none";
				}

				if(milliseconds){
					document.getElementById("milliseconds").style.display = "";
					document.getElementsByName("milliseconds")[0].value=0;
				}else{
					document.getElementById("milliseconds").style.display = "none";
				}

				if(microseconds){
					document.getElementById("microseconds").style.display = "";
					document.getElementsByName("microseconds")[0].value=0;
				}else{
					document.getElementById("microseconds").style.display = "none";
				}

				document.getElementById("boxName").value = box.name;

				timeBoxLoadValues(box, days, hours, minutes, seconds, milliseconds, microseconds);
				var modal = document.getElementById("timeboxModal");
				modal.style.display = "block";
			}

			// When the user clicks on OK button, update the box value
			// Format is dd.hh:mm:ss.mmm.uuu
			function timeBoxSaveValues(){
				var timeboxForm = document.forms.timeboxForm;
				var boxValue = "";
				for(var i=0; i<timeboxForm.length; i+=1) {
					if(timeboxForm[i].type === "number") {
						if(i>0 && boxValue !== "") {
							if (i < 2) {
								boxValue += ".";
							}
							else if (i < 4) {
								boxValue += ":";
							}
							else {
								boxValue += ".";
							}
						}
						boxValue += timeboxForm[i].value;
					}
				}
				var el = document.getElementsByName(document.getElementById("boxName").value)[0];
				el.value = boxValue;
				var modal = document.getElementById("timeboxModal");
				modal.style.display = "none";
			}

			// When the user clicks on input field, loads the current field value in timebox against each input fields
			function timeBoxLoadValues(inputField, days, hours, minutes, seconds, milliseconds, microseconds){
				var timeArray = {
					"days" : true,//days,
					"hours" : true,//hours,
					"minutes" : true,//minutes,
					"seconds" : true,//seconds,
					"milliseconds" : true,//milliseconds,
					"microseconds" : true,//microseconds,
				};
				var j=0;
				var inputFieldValue = inputField.value;
				var splitInputField = inputFieldValue.split(new RegExp("[.:]", "g"));
				for(var key in timeArray){
					if(timeArray[key])
					{
						document.getElementsByName(key)[0].value = splitInputField[j];
						j++;
					}
				}
			}

			function caSetInfoString(str) {
				gInfoString = str;
			}

			function caStartMenuMode(menuString) {
				document.getElementById("title").innerHTML = menuString;
				if (gMenuModeTable !== null) {
					gMenuModeTable.remove();
				}
				gMenuModeTable = document.createElement("table");
				gCurTable = gMenuModeTable;
				gCurTable.classList.add("modeTable");
			}

			function caStartPhotoMode() {
				if (gPhotoModeTable !== null) {
				gPhotoModeTable.remove();
				}
				gPhotoModeTable = document.createElement("table");
				gPhotoModeTable.style.display = "none";
				gCurTable = gPhotoModeTable;
				gCurTable.classList.add("modeTable");
			}

			function caTextStatic(text0) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.colSpan = "2";
				cell0.innerHTML = text0;
				cell0.classList.add("modeCell");
			}

			function caTextDynamic(id, text0, text1) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				cell1.id = id;
				cell1.innerHTML = text1;
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caButton(id, text0, text1) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("button");
				x.type = "button";
				x.caType = "button";
				x.id = id;
				x.innerHTML = text1;
				x.onclick = function(){
					var val = PID_UINT32+"~"+id.substring(2)+"~1~";
					buildHttpRequest("JSCA_RAW_PACKET", true, val);
				};
				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			// <label class="checkbox"><input type="checkbox" name="sequencer1" value="1"/>1<span></span></label>
			function caCheckBox(id, value, text0) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("label");
				var y = document.createElement("input");
				var z = document.createElement("span");
				x.classList.add("checkbox");

				y.type = "checkbox";
				y.caType = "checkbox";
				y.id = id;
				y.checked = value;

				x.appendChild(y);
				x.appendChild(z);
				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caDropSelect(id, value, text0, text1) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("select");
				x.id = id;
				x.caType = "dropSelect";
				var a = text1.split("~");

				a.forEach(function(item) {
					var option = document.createElement("option");
					option.value = item;
					option.textContent = item;
					x.appendChild(option);
				});

				x.classList.add("select1");

				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caDropSelectImmediate(id, value, text0, text1) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("select");
				x.id = id;
				x.caType = "dropSelect";
				var a = text1.split("~");

				a.forEach(function(item) {
					var option = document.createElement("option");
					option.value = item;
					option.textContent = item;
					x.appendChild(option);
				});

				x.classList.add("select1");

				x.onchange = function(){
					var val = PID_UINT32+"~"+id.substring(2)+"~"+x.selectedIndex+"~";
					buildHttpRequest("JSCA_RAW_PACKET", true, val);
				};
				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caEditNumber(id, maxValue, value, text0) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("input");
				x.type = "number";
				x.caType = "editNumber";
				x.id = id;
				x.onkeypress="return event.charCode >= 48 && event.charCode <= 57;";
				x.classList.add("input1");
				x.value = value;
				x.max = maxValue;
				x.oninput = function(){validateNumber(x, null);};
				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caEditNumber2(id0, maxValue0, value0, id1, maxValue1, value1, text0) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				var maxLength0 = maxValue0.toString().length;
				var maxLength1 = maxValue1.toString().length;
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x0 = document.createElement("input");
				x0.type = "number";
				x0.caType = "editNumber";
				x0.id = id0;
				x0.onkeypress="return event.charCode >= 48 && event.charCode <= 57;";
				x0.classList.add("input1");
				x0.value = value0;
				x0.max = maxValue0;
				x0.oninput = function(){validateNumber(x0, null);};
				var x1 = document.createElement("input");
				x1.type = "number";
				x1.caType = "editNumber";
				x1.id = id1;
				x1.onkeypress="return event.charCode >= 48 && event.charCode <= 57;";
				x1.classList.add("input1");
				x1.value = value1;
				x1.max = maxValue1;
				x1.oninput = function(){validateNumber(x1, null);};
				cell1.appendChild(x0);
				cell1.appendChild(x1);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}			
			
			function caTimeBox(id, days, hours, minutes, seconds, milliseconds, microseconds, text0) {
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("input");
				x.type = "text";
				x.caType = "timeBox";
				x.id = id;
				x.name = "timebox";
				x.value = days + "." + hours + ":" + minutes + ":" + seconds + "." + milliseconds + "." + microseconds;
				x.classList.add("inputTimebox");
				x.onclick = function(){
					openTimeBox(x, true, true, true, true, true, true);
				};
				cell1.appendChild(x);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caSlider(id, maxValue, value, text0) {
				var maxLength = maxValue.toString().length;
				var row = gCurTable.insertRow();
				var cell0 = row.insertCell();
				cell0.innerHTML = text0;
				var cell1 = row.insertCell();
				var x = document.createElement("input");
				x.classList.add("slider");
				x.type = "range";
				x.caType = "slider";
				x.id = id;
				x.min=0;
				x.max=maxValue;
				x.value=value;
				x.step="1";
				x.onchange = function(){
					document.getElementById(id+"b").value = x.value;
				};
				x.oninput = function() {
					document.getElementById(id+"b").value = x.value;
				};
				cell1.appendChild(x);
				var x1 = document.createElement("input");
				x1.id = id+"b";
				x1.type = "number";
				x1.onkeypress="return event.charCode >= 48 && event.charCode <= 57;";
				x1.classList.add("inputSlider");
				x1.value = value;
				x1.max = maxValue;
				x1.oninput = function(){validateNumber(x1, id);};
				cell1.appendChild(x1);
				cell0.classList.add("modeCell");
				cell1.classList.add("modeCell");
			}

			function caEndMenu() {
				document.getElementById("menuModeForm").appendChild(gCurTable);
			}

			// Handle pressing the number camera buttons.  (Change colors and save/restor settings)
			function camSelectButton(val) {
				document.getElementById("camSel0").style.background="#9E9E9E";
				document.getElementById("camSel1").style.background="#9E9E9E";
				document.getElementById("camSel2").style.background="#9E9E9E";
				document.getElementById("camSel3").style.background="#9E9E9E";
				document.getElementById("camSel4").style.background="#9E9E9E";
				document.getElementById("camSel5").style.background="#9E9E9E";
				document.getElementById("camSel6").style.background="#9E9E9E";
				document.getElementById("camSel7").style.background="#9E9E9E";
				document.getElementById("camSel"+val).style.background="#0D47A1";
				camSettingsSave(gCamSelectVal);
				camSettingsLoad(val);
				gCamSelectVal = val;
			}

			// Load current camera settings from a string and setup the UI to match those settings
			function camSettingsLoad(index) {
				var strArray = gCamSettingsArray[index].split("~");
				strArray.pop(); // Last element is empty
				var cameraFlashSetupForm = document.forms.cameraFlashSetupForm;
				cameraFlashSetupForm.elements.mode.value = strArray[2];
				cameraFlashSetupForm.elements.delay.value = getTimeBoxString(strArray[3], strArray[4]);
				cameraFlashSetupForm.elements.duration_bulb.value = getTimeBoxString(strArray[5], strArray[6]);
				cameraFlashSetupForm.elements.post_trigger_delay.value = getTimeBoxString(strArray[7], strArray[8]);
				var seq = +strArray[9];
				for(var i=1; i<=8; i++) {
					var value = cameraFlashSetupForm.elements["sequencer"+i].value;
					if (seq & value) {
						cameraFlashSetupForm.elements["sequencer"+i].checked = true;
					}
					else {
						cameraFlashSetupForm.elements["sequencer"+i].checked = false;
					}
				}
				cameraFlashSetupForm.elements["mirror_lockup"].checked = (strArray[10] === "0") ? false : true;
			}

			// Save current camera settings to a string
			function camSettingsSave(index) {
				var cameraFlashSetupForm = document.forms["cameraFlashSetupForm"];
				var str = PID_CAM_SETTINGS + "~" + index + "~";
				var sequencerVal = +0;

				for(var i=0; i<cameraFlashSetupForm.length; i++) {
					if(cameraFlashSetupForm[i].type === "checkbox"){
						if(cameraFlashSetupForm[i].name === "mirror_lockup") {
							str += (cameraFlashSetupForm[i].checked) ? "1~" : "0~";
						}
						else if (cameraFlashSetupForm[i].checked){ // Sequencer check boxes
							sequencerVal += +cameraFlashSetupForm[i].value;
						}
						if(cameraFlashSetupForm[i].name === "sequencer8") {
							str += sequencerVal + "~";
						}
					} else if (cameraFlashSetupForm[i].type === "text") {
						var seconds = getSeconds(cameraFlashSetupForm[i].value);
						var nanoseconds = getNanoseconds(cameraFlashSetupForm[i].value);
						str += seconds + "~" + nanoseconds + "~";
					} else{
						str += cameraFlashSetupForm[i].value + "~";
					}
				}
				gCamSettingsArray[index] = str;
			}

			// Submit packets for menu mode to esp8266
			function submitMenuModeFormPacket() {
				var menuModeForm = document.forms["menuModeForm"];
				var packetStr = gDynamicMenuName+"&";

				for(var i=0; i<menuModeForm.length; i++) {
					var el = menuModeForm[i];
					if (el.caType === "button") {
						//packetStr += PID_UINT32+"~"+el.id.substring(2)+"~1~&";
					} else if (el.caType === "checkbox") {
						packetStr += PID_UINT32+"~"+el.id.substring(2)+"~"+(el.checked ? 1 : 0)+"~&";
					} else if (el.caType === "dropSelect") {
						packetStr += PID_UINT32+"~"+el.id.substring(2)+"~"+el.selectedIndex+"~&";
					} else if (el.caType === "editNumber") {
						packetStr += PID_UINT32+"~"+el.id.substring(2)+"~"+el.value+"~&";
					} else if (el.caType === "timeBox") {
						var seconds = getSeconds(el.value);
						var nanoseconds = getNanoseconds(el.value);
						packetStr += PID_TIME_BOX+"~"+el.id.substring(2)+"~"+seconds+"~"+nanoseconds+"~&";
					} else if (el.caType === "slider") {
						packetStr += PID_UINT32+"~"+el.id.substring(2)+"~"+el.value+"~&";
					}
				}
				buildHttpRequest("JSCA_SET_DYNAMIC_MENU", false, packetStr);
			}

			// Load dynamic menu packets into the current form for the dynamic menu UI
			function loadMenuModeFromPacket(packetArray) {
				var menuModeForm = document.forms["menuModeForm"];
				var j = 0;  // packetArray index doesn't match form since button not sent in submitMenuModeFormPacket()

				for(var i=0; i<menuModeForm.length; i++) {
					var el = menuModeForm[i];
					var packet;
					if (el.caType === "button") {
						// Do nothing
						j--;
					} else if (el.caType === "checkbox") {
						packet = packetArray[j].split("~");
						el.checked = +packet[2];
					} else if (el.caType === "dropSelect") {
						packet = packetArray[j].split("~");
						el.selectedIndex = packet[2];
					} else if (el.caType === "editNumber") {
						packet = packetArray[j].split("~");
						el.value = packet[2];
					} else if (el.caType === "timeBox") {
						packet = packetArray[j].split("~");
						el.value = getTimeBoxString(packet[2], packet[3]);
					} else if (el.caType === "slider") {
						packet = packetArray[j].split("~");
						el.value = packet[2];
                        document.getElementById("id"+packet[1]).value = packet[2];
						document.getElementById("id"+packet[1]+"b").value = packet[2];
					}
					j++;
				}
			}

			// Get voltage of CA6
			function sendVoltagePacket() {
				buildHttpRequest("JSCA_GET_VOLTAGE", true);
			}

			// Submit packets for camera flash to esp8266
			function sendCamFlashPacket() {
				camSettingsSave(gCamSelectVal);
				var str = gCamSettingsArray[0] + "&" + gCamSettingsArray[1] + "&" +
							gCamSettingsArray[2] + "&" + gCamSettingsArray[3] + "&" + gCamSettingsArray[4] + "&" +
							gCamSettingsArray[5] + "&" + gCamSettingsArray[6] + "&" + gCamSettingsArray[7] + "&";
				buildHttpRequest("JSCA_SET_ALL_CAMS", false, str);
			}

			// Submit packet for intervalometer to esp8266
			function sendIntervalometerPacket(){
				var startStr = document.getElementById("start_delay").value;
				var intervalStr = document.getElementById("interval").value;
				var enabled = document.getElementById("inter_enable").checked ? 1 : 0;
				var startSeconds = getSeconds(startStr);
				var startNanoseconds = getNanoseconds(startStr);
				var intervalSeconds = getSeconds(intervalStr);
				var intervalNanoseconds = getNanoseconds(intervalStr);
				var numRepeats = document.getElementById("number_of_repeats").value;
				var str = PID_INTERVALOMETER+"~"+enabled+"~"+startSeconds+"~"+startNanoseconds+"~"+
							intervalSeconds+"~"+intervalNanoseconds+"~"+numRepeats+"~";
				buildHttpRequest("JSCA_RAW_PACKET", true, str);
			}

			// Submit packet to trigger the camera ports to esp8266
			function sendCamTriggerPacket(){
				var str = PID_CAM_TRIGGER+"~0~0~0~";  // Set mode, focus, and shutter to 0
				buildHttpRequest("JSCA_RAW_PACKET", true, str);
			}

			// Run test trigger function
			function testTrigger(extraFunc) {
				if (extraFunc !== null) {
					extraFunc();
				}
				sendCamTriggerPacket();
			}

			// Run function to trigger cams
			function toggleCams() {
				var str = PID_CAM_TRIGGER+"~1~0~0~";  // Set mode to 1, focus/shutter to 0
				buildHttpRequest("JSCA_RAW_PACKET", true, str);
			}

			// Set the start location (home page is default)
			function setStartLocation() {
				var startLocationSelect = document.getElementById("start_location");
				var str = startLocationSelect.options[startLocationSelect.selectedIndex].text;
				buildHttpRequest("JSCA_SET_START_LOCATION", true, str);
			}

			// Reset all the settings to defaults
			function setDefaults() {
				buildHttpRequest("JSCA_SET_DEFAULTS", false);
				buildHttpRequest("JSCA_GET_INTERVAL", false);
				buildHttpRequest("JSCA_GET_ALL_CAMS", false);
				buildHttpRequest("JSCA_GET_START_LOCATION", true);
				loadPage('Home', null, null);
			}

			// Clear wifi network settings from wifi class
			function clearWifiNetworks() {
				buildHttpRequest("JSCA_CLEAR_WIFI_NETWORKS", true);
			}

			// Popup a screen with help info
			function displayInfo() {
				alert(gInfoString);
			}
		</script>
	</head>
	<body>
<!--Timebox Popup (Start)-->
		<div id="timeboxModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h3>Setting Time</h3>
				<form id="timeboxForm" name="timeboxForm">
					<table style="width:100%;">
						<tr style="display:none;" id="days">
							<td style="width:50%;">Days (0-99)</td>
							<td style="width:50%;">
								<input class="input1" type="number" name="days" max="99" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr style="display:none;" id="hours">
							<td >Hours (0-23)</td>
							<td >
								<input class="input1" type="number" name="hours" max="23" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr style="display:none;" id="minutes">
							<td>Minutes (0-59)</td>
							<td>
								<input class="input1" type="number" name="minutes" max="59" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr style="display:none;" id="seconds">
							<td>Seconds (0-59)</td>
							<td>
								<input class="input1" type="number" name="seconds" max="59" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr style="display:none;" id="milliseconds">
							<td>Milliseconds (0-999)</td>
							<td>
								<input class="input1" type="number" name="milliseconds" max="999" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr style="display:none;" id="microseconds">
							<td>Microseconds (0-999)</td>
							<td>
								<input class="input1" type="number" name="microseconds" max="999" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="0" />
							</td>
						</tr>
						<tr>
							<td style="text-align:center;" colspan="2"><br><br><br><br>
								<input type="hidden" id="boxName" name="boxName" value="">
								<button onclick="timeBoxSaveValues();" type="button">Ok</button>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
<!--Timebox Popup (End)-->
<!--Home Page (Start)-->
		<div id="Home" class="mainBox">
			<h1>Camera Axe Home</h1>
			<div class="colorbox">
				<span class="text1">Menus</span>
				<div id="listButtons"></div>
			</div>
			<br>
			<button class="button1" onclick="loadPage('CameraFlash', null, null);">Camera/Flash Settings</button>
			<br>
			<button class="button1" onclick="loadPage('Intervalometer', null, null);">Intervalometer Settings</button>
			<br>
			<button class="button1" onclick="loadPage('Advanced', null, sendVoltagePacket);">Advanced</button>
		</div>
<!--Home Page (End)-->
<!--Menu Mode Page (Start)-->
		<div id="MenuMode" class="mainBox">
			<button onclick="loadPage('Home', null, submitMenuModeFormPacket);">&#x1F3E0;&#xfe0e;</button>
			<button id="MenuPhotoModeButton" onclick="toggleMenuPhotoMode(false, gDynamicMenuName, submitMenuModeFormPacket);">Photo Mode</button>
			<button id="MenuModeTestTriggerButton" onclick="testTrigger(submitMenuModeFormPacket);">Test Trigger</button>
			<button id="MenuModeTriggerCamsButton" onclick="toggleCams();">Trigger Cams</button>
			<button id="MenuInfoButton" onclick="displayInfo();">&#x2139;&#xfe0e;</button>
			<h1 id="title">null</h1>

			<form id="menuModeForm" name="menuModeForm"> </form>

			<script>
				if (uiTestMode) {
					caSetInfoString("Normally you would describe the module menu here.");
					caStartMenuMode("Dummy Menu");
					caTextStatic("Static text");
					caTextDynamic("id0", "Dynamic text", "777");
					caButton("id1", "This is a button", "Button");
					caCheckBox("id2", 0, "This is a checkbox");
					caDropSelect("id3", 0, "This is a dropdown", "no~yes~maybe");
					caDropSelectImmediate("id4", 1, "Drop select immediate", "one~two")
					caEditNumber("id5", 999999, 2, "This is an edit number");
					caEditNumber2("id6", 9999, 50, "id7", 5000, 5, "This is edit2 number");
					caTimeBox("id8", 89, 1, 59, 58, 800, 801, "This is a timebox");
					caSlider("id9", 9998, 10, "This is a slider");
					caEndMenu();
					caStartPhotoMode();
					caTextStatic("Photo Mode");
					caEndMenu();
				}
			</script>
		</div>
<!--Menu Mode Page (End)-->
<!--Camera Flash Page (Start)-->
		<div id="CameraFlash" class="mainBox">
			<button onclick="loadPage('Home', null, sendCamFlashPacket);">&#x1F3E0;&#xfe0e;</button>
			<button onclick="testTrigger(sendCamFlashPacket);" type="button">Test Trigger</button>
			<h1>Camera Flash</h1>

			<button onclick="camSelectButton(0);" id="camSel0">1</button>
			<button onclick="camSelectButton(1);" id="camSel1">2</button>
			<button onclick="camSelectButton(2);" id="camSel2">3</button>
			<button onclick="camSelectButton(3);" id="camSel3">4</button>
			<button onclick="camSelectButton(4);" id="camSel4">5</button>
			<button onclick="camSelectButton(5);" id="camSel5">6</button>
			<button onclick="camSelectButton(6);" id="camSel6">7</button>
			<button onclick="camSelectButton(7);" id="camSel7">8</button>

			<form id="cameraFlashSetupForm" name="cameraFlashSetupForm">
				<table style="width:100%;">
					<tr>
						<td style="width:50%;">Mode</td>
						<td style="width:50%;">
							<select class="select1" name="mode">
								<option value="0">None</option>
								<option value="1">Camera</option>
								<option value="2">Camera Prefocus</option>
								<option value="3">Camera Prefocus Smart</option>
								<option value="4">Flash</option>
							</select>
						</td>
					</tr>
					<tr>
						<td>Delay</td>
						<td>
							<input class="inputTimebox" type="text" name="delay" onclick="openTimeBox(this,true,true,true,true,true,true,true);" value="0.0:0:0.0.0" />
						</td>
					</tr>
					<tr>
						<td>Duration (bulb)</td>
						<td>
							<input class="inputTimebox" type="text" name="duration_bulb" onclick="openTimeBox(this,true,true,true,true,true,true,true);" value="0.0:0:0.0.0" />
						</td>
					</tr>
					<tr>
						<td>Post Trigger Delay</td>
						<td>
							<input class="inputTimebox" type="text" name="post_trigger_delay" onclick="openTimeBox(this,true,true,true,true,true,true,true);" value="0.0:0:0.0.0" />
						</td>
					</tr>
					<tr>
						<td colspan="2">
							Sequencer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							<label class="checkbox"><input type="checkbox" name="sequencer1" value="1"/>1<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer2" value="2"/>2<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer3" value="4"/>3<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer4" value="8"/>4<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer5" value="16"/>5<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer6" value="32"/>6<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer7" value="64"/>7<span></span></label>
							<label class="checkbox"><input type="checkbox" name="sequencer8" value="128"/>8<span></span></label>
						</td>
					</tr>
					<tr>
						<td>Enable Mirror Lockup</td>
						<td>
							<label class="checkbox"><input type="checkbox" name="mirror_lockup"/><span></span></label>
						</td>
					</tr>
				</table>
			</form>
		</div>
<!--Camera Flash Page (End)-->
<!--Intervalometer Page (Start)-->
		<div id="Intervalometer" class="mainBox">
			<button onclick="loadPage('Home', null, sendIntervalometerPacket);">&#x1F3E0;&#xfe0e;</button>
			<button onclick="testTrigger(sendIntervalometerPacket);" type="button">Test Trigger</button>
			<h1>Intervalometer</h1>

			<form id="intervalometerForm" name="intervalometerForm">
				<table style="width:100%;">
					<tr>
						<td style="width:50%;">Enable</td>
						<td style="width:50%;">
							<label class="checkbox"><input type="checkbox" name="inter_enable" id="inter_enable"/><span></span></label>
						</td>
					</tr>
					<tr>
						<td>Start Delay</td>
						<td>
							<input class="inputTimebox" type="text" id="start_delay" name="start_delay" onclick="openTimeBox(this,true,true,true,true,true,true,true);" value="0.0:0:0.0.0" />
						</td>
					</tr>
					<tr>
						<td>Interval</td>
						<td>
							<input class="inputTimebox" type="text" id="interval" name="interval" onclick="openTimeBox(this,true,true,true,true,true,true,true);" value="0.0:0:0.0.0" />
						</td>
					</tr>
					<tr>
						<td>Number of Repeats (0 = Inf)</td>
						<td>
							<input class="input1" type="number" id="number_of_repeats" name="number_of_repeats" max="9999" oninput="validateNumber(this, null);" onkeypress="return event.charCode >= 48 && event.charCode <= 57;" value="0" />
						</td>
					</tr>
				</table>
			</form>
		</div>
<!--Intervalometer Page (End)-->
<!--Advanced Page (Start)-->
		<div id="Advanced" class="mainBox">
			<button onclick="loadPage('Home', null, null);">&#x1F3E0;&#xfe0e;</button>
			<h1>Advanced</h1>

			<p>Start here on startup: <select class="select1" id="start_location" onchange="setStartLocation();"></select></p>
			<p><button onclick="setDefaults();">Set Menu Defaults</button></p>
			<p><button onclick="clearWifiNetworks();">Clear Wifi Settings</button> <br>Turn off power after clicking</p>
			<p>Current voltage: <span id="current_voltage">?</span>
			<p>Version: 2018.1.24</p>
		</div>
<!--Advanced Page (End)-->
	<p id="debugText"></p>
	</body>
</html>